<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>농노코인 거래소</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f8ff; }
  h1 { color: #4CAF50; margin-bottom: 20px; }
  #balanceContainer { position: absolute; top: 10px; right: 10px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 0 5px #aaa; text-align: right; }
  #balance, #coinAmount, #avgPrice { font-size: 1.2em; margin-top: 5px; }
  #coinPrice { font-size: 1.2em; margin: 10px 0; }
  button { font-size: 1.2em; padding: 10px 20px; margin: 5px; }
  canvas { max-width: 100%; height: 300px; margin-top: 20px; }
  #quantityInput { display: none; margin-top: 10px; }
  #quantityInput input { font-size: 1.2em; width: 60px; text-align: center; }
</style>
</head>
<body>

<h1>농노코인 거래소</h1>

<div id="balanceContainer">
  <div id="balance">농노 보유량: 0</div>
  <div id="coinAmount">농노코인 보유량: 0</div>
  <div id="avgPrice">평균 구매 가격: -</div>
</div>

<div id="coinPrice">가격: 0 농노</div>

<button onclick="showBuyInput()">농노코인 사기</button>
<button onclick="showSellInput()">농노코인 팔기</button>

<div id="quantityInput">
  <input type="number" id="quantity" min="1" value="1">
  <button id="confirmBuy">구매</button>
  <button id="confirmSell">판매</button>
  <button onclick="hideQuantityInput()">취소</button>
</div>

<canvas id="priceChart"></canvas>

<script>
// ===== 초기화 =====
let balance = parseFloat(localStorage.getItem("balance")) || 50;
let coinAmount = parseInt(localStorage.getItem("coinAmount")) || 0;
let coinPrice = parseFloat(localStorage.getItem("coinPrice")) || 1;
let totalSpent = parseFloat(localStorage.getItem("totalSpent")) || 0; // 구매 비용 총합

// 마지막 접속 시각
let lastTime = parseInt(localStorage.getItem("lastTime")) || Date.now();

// 접속하지 않은 시간만큼 가격 변동
let now = Date.now();
let deltaSeconds = Math.floor((now - lastTime) / 1000);
for(let i=0; i<deltaSeconds; i++){
    let change = (Math.random() - 0.5) * 1;
    if(coinPrice <= 0.5 && change < 0) change = 0;
    coinPrice += change;
    if(coinPrice < 0.1) coinPrice = 0.1;
    if(coinPrice > 20) coinPrice = 20;
}
lastTime = now;
localStorage.setItem("lastTime", lastTime);

// ===== 화면 업데이트 =====
function updateDisplay() {
  document.getElementById("balance").innerText = `농노 보유량: ${balance.toFixed(2)}`;
  document.getElementById("coinAmount").innerText = `농노코인 보유량: ${Math.floor(coinAmount)}`;
  if(coinAmount > 0) {
    let avgBuyPrice = totalSpent / coinAmount;
    document.getElementById("avgPrice").innerText = `평균 구매 가격: ${avgBuyPrice.toFixed(2)} 농노`;
  } else {
    document.getElementById("avgPrice").innerText = `평균 구매 가격: -`;
    totalSpent = 0; // 코인 0이면 총 구매 비용도 초기화
  }
  document.getElementById("coinPrice").innerText = `가격: ${coinPrice.toFixed(2)} 농노`;

  localStorage.setItem("balance", balance.toFixed(2));
  localStorage.setItem("coinAmount", Math.floor(coinAmount));
  localStorage.setItem("coinPrice", coinPrice.toFixed(2));
  localStorage.setItem("totalSpent", totalSpent.toFixed(2));
}

// ===== Chart.js 초기화 =====
let ctx = document.getElementById('priceChart').getContext('2d');
let chartData = { labels: [], datasets: [{ label: '농노코인 가격', data: [], borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.2)', fill: true, tension: 0.2 }]};
let priceChart = new Chart(ctx, { type: 'line', data: chartData, options: { responsive:true, animation:false, scales: { x:{title:{display:true,text:'시간(초)'}}, y:{title:{display:true,text:'농노코인 가격'},min:0,max:22}}}});

// ===== 가격 자동 변동 =====
let seconds = 0;
function fluctuatePrice() {
  let change = (Math.random() - 0.5) * 1;
  if(coinPrice <= 0.5 && change < 0) change = 0;
  coinPrice += change;
  if(coinPrice < 0.1) coinPrice = 0.1;
  if(coinPrice > 20) coinPrice = 20;
  coinPrice = parseFloat(coinPrice.toFixed(2));

  seconds += 1;
  chartData.labels.push(seconds);
  chartData.datasets[0].data.push(coinPrice);
  priceChart.update();
  updateDisplay();
  lastTime = Date.now();
  localStorage.setItem("lastTime", lastTime);
}
setInterval(fluctuatePrice, 1000);

// ===== 숫자 입력 패드 표시 =====
function showBuyInput() { document.getElementById('quantityInput').style.display='block'; document.getElementById('confirmBuy').style.display='inline'; document.getElementById('confirmSell').style.display='none'; }
function showSellInput() { document.getElementById('quantityInput').style.display='block'; document.getElementById('confirmBuy').style.display='none'; document.getElementById('confirmSell').style.display='inline'; }
function hideQuantityInput() { document.getElementById('quantityInput').style.display='none'; }

// ===== 구매/판매 실행 =====
document.getElementById('confirmBuy').onclick = function() {
  let qty = parseInt(document.getElementById('quantity').value);
  if(isNaN(qty) || qty < 1) return;
  let cost = qty * coinPrice;
  if(balance < cost) { alert("농노가 부족합니다!"); return; }
  balance -= cost;
  coinAmount += qty;
  totalSpent += cost;
  updateDisplay();
  hideQuantityInput();
};

document.getElementById('confirmSell').onclick = function() {
  let qty = parseInt(document.getElementById('quantity').value);
  if(isNaN(qty) || qty < 1) return;
  if(coinAmount < qty) { alert("농노코인이 부족합니다!"); return; }
  balance += qty * coinPrice;
  coinAmount -= qty;
  totalSpent = Math.max(totalSpent - (totalSpent/coinAmount*qty || 0), 0); // 판매 후 총 구매 비용 조정
  updateDisplay();
  hideQuantityInput();
};

// 초기 표시
updateDisplay();
</script>

</body>
</html>
